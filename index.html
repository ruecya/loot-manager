<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì „ë¦¬í’ˆ ë§¤ë‹ˆì € v8 (GitHub í´ë¼ìš°ë“œ ì—°ë™)</title>
  <style>
    :root {
      --primary: #4f46e5; --primary-hover: #4338ca;
      --danger: #ef4444; --success: #10b981;
      --bg: #f3f4f6; --card-bg: #ffffff;
      --text-main: #1f2937; --text-muted: #6b7280;
      --border: #e5e7eb; --radius: 8px;
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      --github: #24292f;
    }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 0; line-height: 1.5; }
    .container { max-width: 1000px; margin: 0 auto; padding: 16px; }
    
    /* Nav */
    .nav-tabs { display: flex; gap: 8px; background: var(--card-bg); padding: 8px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; overflow-x: auto; }
    .nav-btn { flex: 1; padding: 10px; border: none; background: transparent; color: var(--text-muted); font-weight: 600; cursor: pointer; border-radius: 6px; white-space: nowrap; transition: 0.2s; }
    .nav-btn:hover { background: var(--bg); color: var(--text-main); }
    .nav-btn.active { background: var(--primary); color: white; }

    /* UI Components */
    .card { background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; margin-bottom: 20px; border: 1px solid var(--border); }
    .card h3 { margin: 0 0 16px 0; border-bottom: 1px solid var(--border); padding-bottom: 10px; font-size: 1.25rem; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .col { display: flex; flex-direction: column; gap: 8px; }
    input, select, textarea { padding: 10px; border: 1px solid var(--border); border-radius: 6px; width: 100%; }
    input:focus { outline: 2px solid var(--primary); border-color: transparent; }
    button { padding: 10px 16px; border-radius: 6px; border: 1px solid var(--border); background: white; cursor: pointer; font-weight: 500; transition: 0.2s; display:inline-flex; align-items:center; justify-content:center; gap:6px; }
    button:hover { background: #f9fafb; }
    button.primary { background: var(--primary); color: white; border-color: var(--primary); }
    button.primary:hover { background: var(--primary-hover); }
    button.danger { color: var(--danger); border-color: var(--danger); }
    button.github { background: var(--github); color: white; border-color: var(--github); }
    button.github:hover { opacity: 0.9; }
    button.sm { padding: 4px 10px; font-size: 0.85rem; }

    /* Tables & Badges */
    .table-responsive { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th { background: #f9fafb; padding: 12px; text-align: left; border-bottom: 2px solid var(--border); white-space: nowrap; }
    td { padding: 12px; border-bottom: 1px solid var(--border); }
    .badge { padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
    .badge.on { background: #d1fae5; color: #065f46; }
    .badge.off { background: #f3f4f6; color: #6b7280; }
    .badge.done { background: #fef3c7; color: #92400e; }
    .badge.ready { background: #e0e7ff; color: #3730a3; }
    .drag-handle { cursor: grab; padding-right: 8px; color: var(--text-muted); }
    tr.drag-over td { background: #eef2ff; border-top: 2px dashed var(--primary); }
    
    /* Github Config Box */
    .gh-config { background: #24292f; color: #fff; padding: 16px; border-radius: 8px; margin-bottom: 16px; }
    .gh-config input { background: #0d1117; border: 1px solid #30363d; color: #fff; }
    .gh-config label { font-size: 0.85rem; color: #8b949e; display: block; margin-bottom: 4px; }
    .status-msg { font-size: 0.9rem; margin-left: 8px; font-weight: 600; }
  </style>
</head>
<body>

<div class="container">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
    <h2 style="margin:0;">âš”ï¸ ì „ë¦¬í’ˆ ë§¤ë‹ˆì € v8</h2>
    <span style="font-size:0.85rem; color:#666; background:#fff; padding:4px 8px; border-radius:12px; border:1px solid #ddd;">GitHub Sync Enabled</span>
  </div>

  <div class="nav-tabs">
    <button id="tabRoster" class="nav-btn active">ğŸ‘¥ ëª…ë‹¨/ëª©ë¡</button>
    <button id="tabFixed" class="nav-btn">ğŸ’ ê³ ì •í…œ ë ˆì¸</button>
    <button id="tabLoot" class="nav-btn">ğŸ² ì „ë¦¬í…œ ë ˆì¸</button>
    <button id="tabLogs" class="nav-btn">â˜ï¸ í´ë¼ìš°ë“œ/ë°±ì—…</button>
  </div>

  <div id="view"></div>
</div>

<script>
/**
 * v8 ë³€ê²½ì :
 * - GitHub API ì—°ë™ (Save / Load)
 * - í•œê¸€ ê¹¨ì§ ë°©ì§€ë¥¼ ìœ„í•œ Base64 ì¸ì½”ë”©/ë””ì½”ë”© ì²˜ë¦¬
 */

const STORAGE_KEY = "loot_manager_v5";

// --- Base64 UTF-8 Helpers (í•œê¸€ ì²˜ë¦¬ìš©) ---
function utf8_to_b64(str) {
  return window.btoa(unescape(encodeURIComponent(str)));
}
function b64_to_utf8(str) {
  return decodeURIComponent(escape(window.atob(str)));
}

// --- Utils ---
function nowTs(){ return Date.now(); }
function fmt(ts){
  const d = new Date(ts);
  const pad = n => String(n).padStart(2,"0");
  return `${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function safeText(s){ return (s||"").trim() || "(ë¯¸ì…ë ¥)"; }
function moveArrayItem(arr, f, t){
  if(f===t) return arr;
  const c = arr.slice();
  const [i] = c.splice(f,1);
  c.splice(t,0,i);
  return c;
}

// --- State ---
function defaultState(){
  return {
    players: [],
    fixedPointer: 0, lootPointer: 0,
    fixedItemName: "ê³ ì •í…œ", lootCatalog: [],
    batchId: null,
    batchReceivedFixed: {}, batchReceivedLoot: {},
    logs: [],
    // GitHub Settings
    gh: { token: "", owner: "", repo: "", path: "data.json" },
    ui: { showDangerButtons: false }
  };
}
let state = loadState();

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? { ...defaultState(), ...JSON.parse(raw) } : defaultState();
  }catch(e){ return defaultState(); }
}
function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}
function logEvent(type, itemName, receiverId, detail, meta={}){
  state.logs.unshift({ ts: nowTs(), type, itemName, receiverId, detail, meta });
  saveState();
}

// --- GitHub API Logic ---
async function githubOp(mode) {
  const { token, owner, repo, path } = state.gh;
  const statusEl = document.getElementById("ghStatus");
  
  if(!token || !owner || !repo){
    alert("GitHub ì„¤ì •(í† í°, ì•„ì´ë””, ì €ì¥ì†Œ)ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }

  const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
  const headers = {
    "Authorization": `token ${token}`,
    "Accept": "application/vnd.github.v3+json"
  };

  try {
    if(statusEl) statusEl.textContent = "â³ ì²˜ë¦¬ ì¤‘...";

    // 1. í˜„ì¬ íŒŒì¼ ìƒíƒœ í™•ì¸ (SHA ê°’ ì–»ê¸° ìœ„í•´ í•„ìˆ˜)
    let sha = null;
    let existingContent = null;
    try {
      const res = await fetch(apiUrl, { headers });
      if(res.ok) {
        const data = await res.json();
        sha = data.sha;
        existingContent = data.content; // Base64
      }
    } catch(e) {}

    if (mode === "LOAD") {
      if(!sha) throw new Error("ì €ì¥ì†Œì— íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.");
      const jsonStr = b64_to_utf8(existingContent.replace(/\n/g, ''));
      const parsed = JSON.parse(jsonStr);
      
      // Merge state
      state = { ...defaultState(), ...parsed, gh: state.gh }; // ì„¤ì •ì€ í˜„ì¬ ì„¤ì • ìœ ì§€
      saveState();
      render();
      alert("âœ… GitHubì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
    } 
    else if (mode === "SAVE") {
      const contentStr = JSON.stringify(state, null, 2);
      const contentB64 = utf8_to_b64(contentStr);
      
      const body = {
        message: `Loot Manager Auto Save (${new Date().toLocaleString()})`,
        content: contentB64
      };
      if(sha) body.sha = sha; // ì—…ë°ì´íŠ¸ ì‹œ SHA í•„ìˆ˜

      const putRes = await fetch(apiUrl, {
        method: "PUT",
        headers,
        body: JSON.stringify(body)
      });

      if(!putRes.ok) throw new Error(`ì €ì¥ ì‹¤íŒ¨ (${putRes.status})`);
      alert("âœ… GitHubì— ì„±ê³µì ìœ¼ë¡œ ì €ì¥í–ˆìŠµë‹ˆë‹¤!");
    }

    if(statusEl) statusEl.textContent = "âœ¨ ì™„ë£Œ";

  } catch (err) {
    console.error(err);
    alert(`ì˜¤ë¥˜ ë°œìƒ: ${err.message}`);
    if(statusEl) statusEl.textContent = "âŒ ì‹¤íŒ¨";
  }
}

// --- DOM Helpers ---
function el(tag, props={}, children=[]){
  const n = document.createElement(tag);
  Object.entries(props).forEach(([k,v])=>{
    if(k==="class") n.className=v; else if(k.startsWith("on")) n.addEventListener(k.slice(2),v); else n.setAttribute(k,v);
  });
  (Array.isArray(children)?children:[children]).forEach(c=>c&&n.appendChild(typeof c==="string"?document.createTextNode(c):c));
  return n;
}
let currentTab = "roster";
function setTab(t){
  currentTab=t; 
  ["roster","fixed","loot","logs"].forEach(x=>document.getElementById("tab"+x.charAt(0).toUpperCase()+x.slice(1)).classList.toggle("active", x===t));
  render();
}
["roster","fixed","loot","logs"].forEach(t=>document.getElementById("tab"+(t.charAt(0).toUpperCase()+t.slice(1))).onclick=()=>setTab(t));

function render(){ document.getElementById("view").innerHTML=""; document.getElementById("view").appendChild(currentView()); }
function currentView(){
  if(currentTab==="roster") return viewRoster();
  if(currentTab==="fixed") return viewLane("fixed");
  if(currentTab==="loot") return viewLane("loot");
  return viewLogs();
}

// --- Views ---
function viewRoster(){
  const wrap = el("div");
  // Top Stats
  wrap.appendChild(el("div", {class:"card"}, [
    el("div",{class:"row"},[
      el("h3",{style:"margin:0"},"ğŸ‘¥ ì°¸ì—¬ì ê´€ë¦¬"),
      el("span",{class:"badge ready"},`ì´ì› ${state.players.length}ëª…`)
    ]),
    el("div",{class:"hr"}),
    el("div",{class:"row"},[
      el("input",{id:"newName",placeholder:"ì´ë¦„",style:"flex:1"}),
      el("button",{class:"primary",onclick:()=>{
        const n=document.getElementById("newName").value.trim();
        if(n){ state.players.push({id:String(Math.random()).slice(2),name:n,activeFixed:true,activeLoot:true,fixedCount:0,lootCount:0,tokens:0}); saveState(); render(); }
      }},"ì¶”ê°€"),
      el("button",{onclick:()=>{ if(confirm("ë°°ì¹˜ ì´ˆê¸°í™”?")) startBatch(); render(); }}, "âš”ï¸ ë°°ì¹˜ ì´ˆê¸°í™”")
    ])
  ]));

  // Table
  const tbody = el("tbody");
  state.players.forEach((p,i)=>{
    const tr = el("tr",{},[
      el("td",{},el("div",{class:"row",style:"gap:4px"},[
        el("span",{class:"drag-handle"},"â‰¡"), el("span",{},String(i+1)),
        el("button",{class:"sm",onclick:()=>{ reorder(i,-1) }},"â–²"),
        el("button",{class:"sm",onclick:()=>{ reorder(i,1) }},"â–¼")
      ])),
      el("td",{style:"font-weight:600"},p.name),
      el("td",{},el("button",{class:p.activeFixed?"sm primary":"sm",onclick:()=>{p.activeFixed=!p.activeFixed; clamp("fixed"); saveState(); render();}},p.activeFixed?"ON":"OFF")),
      el("td",{},el("button",{class:p.activeLoot?"sm primary":"sm",onclick:()=>{p.activeLoot=!p.activeLoot; clamp("loot"); saveState(); render();}},p.activeLoot?"ON":"OFF")),
      el("td",{},el("span",{class:canReceive("fixed",p.id)?"badge ready":"badge done"},canReceive("fixed",p.id)?"ëŒ€ê¸°":"ì™„ë£Œ")),
      el("td",{},String(p.tokens)),
      el("td",{},el("button",{class:"sm danger",onclick:()=>{state.players.splice(i,1); saveState(); render();}},"ì‚­ì œ"))
    ]);
    tr.draggable=true;
    tr.ondragstart=()=>_dragId=p.id;
    tr.ondragover=(e)=>{e.preventDefault(); tr.classList.add("drag-over");};
    tr.ondragleave=()=>tr.classList.remove("drag-over");
    tr.ondrop=(e)=>{e.preventDefault(); tr.classList.remove("drag-over"); reorderId(_dragId,p.id);};
    tbody.appendChild(tr);
  });
  wrap.appendChild(el("div",{class:"card table-responsive"}, el("table",{},[
    el("thead",{},el("tr",{},[el("th",{},"ìˆœì„œ"),el("th",{},"ì´ë¦„"),el("th",{},"ê³ ì •"),el("th",{},"ì „ë¦¬"),el("th",{},"ë°°ì¹˜ìƒíƒœ"),el("th",{},"í† í°"),el("th",{},"ê´€ë¦¬")])),
    tbody
  ])));
  return wrap;
}

function viewLane(which){
  const wrap = el("div");
  const p = peek(which);
  const n = laneCount(which);
  
  const act = el("div",{class:"current-player-box"},[
    el("div",{style:"font-size:0.9rem; color:#666"}, `${which==="fixed"?"ê³ ì •":"ì „ë¦¬"}í…œ ì°¨ë¡€`),
    el("div",{class:"current-player-name"}, p.player ? p.player.name : "(ëŒ€ìƒ ì—†ìŒ)"),
    p.offset>0 ? el("div",{style:"color:red; font-size:0.8rem"}, `â€» ì•ì„  ${p.offset}ëª…(ì™„ë£Œì) ìë™ ìŠ¤í‚µë¨`) : null,
    el("div",{class:"row",style:"justify-content:center; margin-top:10px"},[
      el("button",{class:"primary",onclick:()=>{
        if(!check(which))return;
        give(which);
      }}, "ğŸ ì§€ê¸‰ (ì™„ë£Œì²˜ë¦¬)"),
      el("button",{onclick:()=>{ if(check(which)){ step(which); render(); } }}, "â­ ìŠ¤í‚µ"),
      which==="loot" ? el("button",{class:"github",onclick:()=>{ // Pass Token
         if(!check(which))return;
         const cur=getCur(which); cur.tokens++; step(which); logEvent("PASS_TOKEN","(íŒ¨ìŠ¤)",cur.id,"í† í°+1"); render();
      }}, "ğŸª™ íŒ¨ìŠ¤(í† í°+1)") : null
    ])
  ]);
  
  wrap.appendChild(el("div",{class:"card"},[
    el("h3",{}, which==="fixed"?"ğŸ’ ê³ ì •í…œ ë¶„ë°°":"ğŸ² ì „ë¦¬í…œ ë¶„ë°°"),
    el("div",{class:"row",style:"margin-bottom:10px"},[el("span",{class:"badge ready"},`ì°¸ì—¬ ${n}ëª…`), el("span",{class:"badge done"},`ì™„ë£Œ ${batchSummary(which)}ëª…`)]),
    act
  ]));
  return wrap;
}

function viewLogs(){
  const wrap = el("div");

  // GitHub Config Section
  const ghWrap = el("div", {class:"gh-config"}, [
    el("h4", {style:"margin:0 0 10px 0; border-bottom:1px solid #444; padding-bottom:8px;"}, "â˜ï¸ GitHub ì €ì¥ì†Œ ì—°ê²° ì„¤ì •"),
    el("div", {class:"row"}, [
        el("div", {class:"col", style:"flex:1"}, [ el("label",{},"Repo Owner (ID)"), el("input", {value:state.gh.owner, onchange:(e)=>{state.gh.owner=e.target.value; saveState();}, placeholder:"ì˜ˆ: my-id"}) ]),
        el("div", {class:"col", style:"flex:1"}, [ el("label",{},"Repo Name"), el("input", {value:state.gh.repo, onchange:(e)=>{state.gh.repo=e.target.value; saveState();}, placeholder:"ì˜ˆ: loot-manager"}) ]),
        el("div", {class:"col", style:"flex:1"}, [ el("label",{},"File Path"), el("input", {value:state.gh.path, onchange:(e)=>{state.gh.path=e.target.value; saveState();}, placeholder:"data.json"}) ]),
    ]),
    el("div", {class:"col", style:"margin-top:10px"}, [
        el("label",{},"Personal Access Token (Repo ê¶Œí•œ í•„ìˆ˜)"),
        el("input", {type:"password", value:state.gh.token, onchange:(e)=>{state.gh.token=e.target.value; saveState();}, placeholder:"ghp_..."})
    ]),
    el("div", {class:"row", style:"margin-top:16px"}, [
        el("button", {class:"github", onclick:()=>githubOp("SAVE")}, "â¬†ï¸ GitHubì— ì €ì¥"),
        el("button", {class:"github", onclick:()=>githubOp("LOAD")}, "â¬‡ï¸ GitHubì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°"),
        el("span", {id:"ghStatus", class:"status-msg"}, "")
    ])
  ]);

  wrap.appendChild(el("div", {class:"card"}, [ghWrap]));

  // Log Table
  const tbody = el("tbody");
  state.logs.slice(0,50).forEach(l=>{
    tbody.appendChild(el("tr",{},[
      el("td",{class:"muted"},fmt(l.ts)),
      el("td",{},l.type),
      el("td",{},l.itemName||"-"),
      el("td",{},(state.players.find(p=>p.id===l.receiverId)||{}).name||"-"),
      el("td",{},l.detail)
    ]));
  });
  wrap.appendChild(el("div",{class:"card table-responsive"}, el("table",{},[
     el("thead",{},el("tr",{},[el("th",{},"ì‹œê°„"),el("th",{},"ìœ í˜•"),el("th",{},"í…œ"),el("th",{},"ëŒ€ìƒ"),el("th",{},"ë‚´ìš©")])),
     tbody
  ])));
  return wrap;
}

// --- Logic Helpers ---
let _dragId=null;
function reorder(i,d){ const j=i+d; if(j<0||j>=state.players.length)return; state.players=moveArrayItem(state.players,i,j); saveState(); render(); }
function reorderId(fId,tId){ if(fId===tId)return; const f=state.players.findIndex(p=>p.id===fId), t=state.players.findIndex(p=>p.id===tId); state.players=moveArrayItem(state.players,f,t); saveState(); render(); }
function startBatch(){ state.batchId=nowTs(); state.batchReceivedFixed={}; state.batchReceivedLoot={}; logEvent("BATCH","(ì´ˆê¸°í™”)",null,"ìƒˆ ë°°ì¹˜ ì‹œì‘"); saveState(); }
function canReceive(w,id){ return w==="fixed"?!state.batchReceivedFixed[id]:!state.batchReceivedLoot[id]; }
function batchSummary(w){ return Object.keys(w==="fixed"?state.batchReceivedFixed:state.batchReceivedLoot).length; }
function laneCount(w){ return state.players.filter(p=>p[w==="fixed"?"activeFixed":"activeLoot"]).length; }
function clamp(w){ const k=w==="fixed"?"fixedPointer":"lootPointer", n=laneCount(w); state[k]=n===0?0:((state[k]%n)+n)%n; }
function getCur(w){ const arr=state.players.filter(p=>p[w==="fixed"?"activeFixed":"activeLoot"]); clamp(w); return arr[state[w==="fixed"?"fixedPointer":"lootPointer"]]; }
function step(w,s=1){ const n=laneCount(w); if(n>0){ const k=w==="fixed"?"fixedPointer":"lootPointer"; state[k]=(state[k]+s)%n; saveState(); } }
function peek(w){
  const arr=state.players.filter(p=>p[w==="fixed"?"activeFixed":"activeLoot"]);
  const n=arr.length, k=w==="fixed"?"fixedPointer":"lootPointer";
  clamp(w);
  for(let i=0;i<n;i++){
    const p=arr[(state[k]+i)%n];
    if(canReceive(w,p.id)) return {player:p, offset:i};
  }
  return {player:null, offset:0};
}
function check(w){
  if(laneCount(w)===0) {alert("ì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤."); return false;}
  const p=peek(w);
  if(!p.player){ alert("ëª¨ë‘ ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤."); return false; }
  if(p.offset>0) step(w, p.offset);
  return true;
}
function give(w){
  const cur=getCur(w);
  if(w==="fixed") state.batchReceivedFixed[cur.id]=true; else state.batchReceivedLoot[cur.id]=true;
  if(w==="fixed") cur.fixedCount++; else cur.lootCount++;
  logEvent("GIVE",w,cur.id,`${cur.name} ìˆ˜ë ¹`);
  step(w); render();
}

// Init
setTab("roster");
</script>
</body>
</html>
